<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>ToDo</title>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Мои задачи</h1>

        <div class="card mb-4">
            <div class="card-body">
                <form id="taskForm">
                    <div class="mb-3">
                        <input type="text" id="title" class="form-control" placeholder="Название задачи (мин. 3 символа)" required minlength="3">
                    </div>
                    <div class="mb-3">
                        <textarea id="details" class="form-control" rows="2" placeholder="Описание (опционально)"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Приоритет</label>
                        <select id="priority" class="form-select">
                            <option value="1">Низкий</option>
                            <option value="2" selected>Средний</option>
                            <option value="3">Высокий</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Срок выполнения</label>
                        <input type="datetime-local" id="due_date" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Добавить задачу</button>
                </form>
            </div>
        </div>

        <div id="tasks">
            <div class="text-center text-muted py-4">Загрузка задач...</div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    </div>
    <script>
        const API_BASE = '/tasks';
        const tasksContainer = document.getElementById('tasks');
        const taskForm = document.getElementById('taskForm');

        function toLocalISO(dateStr) {
            if (!dateStr) return '';
            const dt = new Date(dateStr);
            const pad = n => n.toString().padStart(2, '0');
            return `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(dt.getDate())}T${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—';
            return new Date(dateStr).toLocaleString('ru-RU', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getPriorityBadge(priority) {
            const labels = ['', 'Низкий', 'Средний', 'Высокий'];
            const classes = ['', 'bg-success', 'bg-warning text-dark', 'bg-danger'];
            return `<span class="badge ${classes[priority]} priority-badge">${labels[priority]}</span>`;
        }

        function renderTasks(tasks) {
            if (tasks.length === 0) {
                tasksContainer.innerHTML = '<div class="text-center text-muted py-4">Нет задач</div>';
                return;
            }

            tasksContainer.innerHTML = tasks.map(task => `
                <div class="card task-card mb-3" data-id="${task.id}">
                    <div class="card-body d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1">
                                ${task.is_done ? '✅ ' : ''}${task.title}
                            </h5>
                            ${task.details ? `<p class="card-text text-muted mb-1">${task.details}</p>` : ''}
                            <small class="text-muted">
                                До: ${formatDate(task.due_date)} ${getPriorityBadge(task.priority)}
                            </small>
                        </div>
                        <div>
                            <button class="btn btn-sm ${task.is_done ? 'btn-outline-success' : 'btn-success'} me-1"
                                    onclick="toggleDone(${task.id}, ${!task.is_done})">
                                ${task.is_done ? 'Снять' : 'Готово'}
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">
                                Удалить
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadTasks() {
            try {
                const res = await fetch(API_BASE);
                const tasks = await res.json();
                renderTasks(tasks);
            } catch (e) {
                tasksContainer.innerHTML = '<div class="text-center text-danger py-4">Ошибка загрузки задач</div>';
            }
        }

        async function createTask(data) {
            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    loadTasks();
                    taskForm.reset();
                    document.getElementById('due_date').value = '';
                }
            } catch (e) {
                alert('Не удалось создать задачу');
            }
        }

        async function toggleDone(id, is_done) {
            try {
                await fetch(`${API_BASE}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_done })
                });
                loadTasks();
            } catch (e) {
                alert('Не удалось обновить статус');
            }
        }

        async function deleteTask(id) {
            if (!confirm('Удалить задачу?')) return;
            try {
                await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
                loadTasks();
            } catch (e) {
                alert('Не удалось удалить задачу');
            }
        }

        taskForm.addEventListener('submit', e => {
            e.preventDefault();
            const formData = new FormData(taskForm);
            const dueDateInput = document.getElementById('due_date').value;
            const dueDate = dueDateInput ? new Date(dueDateInput).toISOString() : null;

            createTask({
                title: formData.get('title'),
                details: formData.get('details') || null,
                priority: parseInt(formData.get('priority')),
                due_date: dueDate,
                is_done: false
            });
        });

        loadTasks();
    </script>
</body>
</html>